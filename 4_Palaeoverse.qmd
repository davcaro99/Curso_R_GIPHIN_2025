---
title: "M칩dulo 4: Palaeoverse"
author: "David Caro, GIPHIN"
date: "06/14/2025"
format: 
  pdf:
    toc: true
  html:
    toc: true
    code-background: true
editor: visual
---

# Palaeoverse

![](images/clipboard-2303701370.png)

![](images/clipboard-2658926087.png){width="305"}

`palaeoverse` es un paquete de R que busca **facilitar el an치lisis de datos paleontol칩gicos**. Proporciona herramientas para:

-   Estandarizar datos f칩siles

-   Analizar riqueza taxon칩mica y patrones de muestreo

-   Realizar simulaciones paleontol칩gicas

-   Visualizar y conectar datos de bases abiertas

El paquete es parte de un ecosistema m치s amplio que incluye paquetes complementarios como `sepkosky`, `phylopic` y `macrostrat`.

## 游댕 Paquetes relacionados

| Paquete | 쯈u칠 hace? |
|------------------------------------|------------------------------------|
| `palaeoverse` | Funciones para estandarizar, analizar y visualizar datos f칩siles |
| `sepkosky` | Accede a la base de datos de Sepkoski con informaci칩n de g칠neros marinos f칩siles |
| `phylopic` | Permite a침adir siluetas de organismos f칩siles a gr치ficos de R |
| `macrostrat` | Conecta con la base de datos Macrostrat (estratigraf칤a y litolog칤a) |

### 游눹 Instalaci칩n

``` r
# Instalar desde CRAN o GitHub 
install.packages("ggspatial")
install.packages("palaeoverse") 
install.packages("sepkosky")
install.packages("rmacrostrat") 
install.packages("rphylopic") 
```

En caso de no funcionar con la instalaci칩n t칤pica lo hacemos por GitHub:

``` r
install.packages("devtools")
devtools::install_github("palaeoverse/palaeoverse")
devtools::install_github("palaeoverse/rmacrostrat")
install.packages("remotes")
remotes::install_github("palaeoverse/rphylopic")
```

### Cargar paquetes

```{r}
#| message: false
#| warning: false
#| echo: true
library(palaeoverse) 
library(rphylopic) 
library(rmacrostrat) 
library(tidyverse)
library(ggplot2)
library(ggspatial)
```

# Divesidad de Tetr치podos 

Este ejercicio est치 inspirado por un ejemplo de [Palaeoverse tetr치podos del Carbonifero y P칠rmico](https://palaeoverse.r-universe.dev/articles/palaeoverse/tetrapod-biodiversity.html)

## Importar y revisar los datos

Como siempre lo primero es revisar la estructura de los datos y su organizaci칩n

```{r}
# Importamos los datos de Tetr치podos
data(tetrapods)

str(tetrapods)

unique(tetrapods$class)
```

::: callout-important
## Ejercicio

Crea una variable con la edad m치xima y otro con la m칤nima
:::

```{r}
#| warning: false
#| code-fold: true

lim_menor <- min(tetrapods$min_ma)
lim_mayor <- max(tetrapods$max_ma)
```

## Explorando las funciones de `palaeoverse`

### Datos temporales

Palaeoverse tiene muchas funciones 칰tiles para trabajar con datos temporales como `time_bins()`

```{r}
# Creamos el intervalo temporal que deseamos usando time_bins()
pisos<- time_bins(interval = c("Carboniferous", "Permian"),
                  # Queremos que la divisi칩n sea en pisos
                  rank = "stage",
                  # Que use los datos de la tabla del 2020
                  scale = "GTS2020",
                  # Visualizamos los intervalos creados
                  plot = TRUE)
head(pisos)
```

`palaeoverse` nos permite ajustar las edades n칰mericas seg칰n el nombre del periodo

```{r}
#| warning: false

# Usamos la funci칩n look_up que compara los valores y nos regresa dos columnas
tetrapods <- look_up(tetrapods, int_key = interval_key)


# Reemplazamos valores NA con los originales
# ifelse nos permite hacer la evaluaci칩n directamente para todos los elementos
tetrapods$interval_max_ma <- ifelse(is.na(tetrapods$interval_max_ma),
                                    tetrapods$max_ma, tetrapods$interval_max_ma)

tetrapods$interval_min_ma <- ifelse(is.na(tetrapods$interval_min_ma),
                                    tetrapods$min_ma, tetrapods$interval_min_ma)

# Calcular edad media
tetrapods$interval_mid_ma <- (tetrapods$min_ma + tetrapods$max_ma)/2

# str(tetrapods)

# Removemos los valores que est칠n por fuera del intervalo deseado

cp_tetrapods <- subset(tetrapods, min_ma > min(pisos$min_ma) & max_ma < 
                         max(pisos$max_ma))

# Ocurrencias asignadas por los intervalos deseados
# Este met칩do asigna la ocurrencia al intervalo donde est치 su mayor parte
maj_tetrapods <- bin_time(occdf = cp_tetrapods,
                          bins = pisos,
                          method = 'majority')

colnames(maj_tetrapods)
```

### Datos espaciales

`palaeoverse` tambien nos permite obtener las paleocoordenadas de los puntos usando la funci칩n `palaeorotate()`

```{r}
#| message: false
#| warning: false
#| echo: true

# Obtener las paleocoordenadas de los puntos
maj_tetrapods <- palaeorotate(occdf = maj_tetrapods, age = "bin_midpoint",
                              # Usaremos el famoso Paleomap como referencia
                              method = "point", model = "PALEOMAP")
```

Si deseamos estudiar la distribuci칩n espacial de los datos lo mejor es hacer una grilla para as칤 poder agrupar las ocurrencias y estudiarlas de manera discreta

```{r}
# Creamos un intervalo espacial que es basicamente una grilla

maj_tetrapods <- bin_space(occdf = maj_tetrapods,
                           lng = 'p_lng',
                           lat = 'p_lat',
                           spacing = 100)
```

::: callout-important
## Ejercicio

Qu칠 variables hemos a침adido al data frame original y cu치l es el significado de cada una de ellas?
:::

## Diversidad

Vamos a usar algunas funciones para ver la diversidad de tetr치podos

```{r}
# Esta funci칩n filtra todos los valores 칰nicos en cuanto a los taxones
generos_tetra <- tax_unique(maj_tetrapods,
                         genus = "genus",
                         family = "family",
                         order = "order",
                         class = "class",
                         # Queremos que se tenga hasta el nivel de g칠nero
                         resolution = "genus")

str(generos_tetra)
length(unique(maj_tetrapods$genus))
```

::: callout-important
## Ejercicio

쯇or qu칠 el largo de valores 칰nicos de `maj_tetrapods$genus` es 2 filas mayor que el data frame?
:::

Para calcular la diversidad tendremos en cuenta la cantidad de ocurrencias por colecci칩n

```{r}
# Esta funci칩n nos permite extraer la cantidad de g칠neros por colecci칩n
coll_genera <- group_apply(occdf = maj_tetrapods,
                           group = c("collection_no"),
                           fun = tax_unique,
                           genus = "genus",
                           family = "family",
                           order = "order",
                           class = "class",
                           resolution = "genus")


# Obtenemos los nombres de g칠neros 칰nicos por colecci칩n
unique_genera <- unique(coll_genera[, c("unique_name", "collection_no")])
# Calculamos el n칰mero de g칠neros 칰nicos por colecci칩n
coll_taxa <- group_apply(unique_genera, group = "collection_no", fun = nrow)
# Renombramos las columnas
colnames(coll_taxa) <- c("n_taxa", "collection_no")
# Seleccionamos las columnas de edad geol칩gica por colecci칩n
coll_info <- maj_tetrapods[, c("collection_no", "max_ma", "interval_mid_ma", "min_ma")]
# Eliminamos colecciones duplicadas
coll_info <- coll_info[!duplicated(coll_info[1]), ]
# Combinamos la informaci칩n de edad con la cantidad de g칠neros
alpha_data <- merge(coll_info, coll_taxa, by = "collection_no")
# Revisamos del nuevo dataframe
str(alpha_data)

```

Ahora vamos a graficar usando las funciones de palaeoverse

```{r}

# Crear el gr치fico de diversidad alfa (n칰mero de taxones por colecci칩n) en el tiempo
plot(alpha_data$interval_mid_ma,     # Coordenada x: edad media (en Ma) de cada colecci칩n
     alpha_data$n_taxa,              # Coordenada y: n칰mero de g칠neros 칰nicos por colecci칩n
     axes = FALSE,                   # No dibujar los ejes por defecto, los agregaremos manualmente
     xlim = rev(range(alpha_data$interval_mid_ma, na.rm = TRUE)),  # Invertir el eje x (de pasado a presente)
     xlab = " ",                     # Etiqueta vac칤a por ahora, la agregaremos m치s abajo
     ylab = "No. taxa",              # Etiqueta del eje y
     pch = 19,                       # Estilo de punto: s칩lido
     col = "#0e826f")                # Color del punto (verde azulado)

# A침adir un marco (box) alrededor del gr치fico
box()

# A침adir el eje vertical (eje Y) en el lado izquierdo
axis(2)

# A침adir el eje X con nombres geol칩gicos (칠pocas y periodos)
# Esta funci칩n es del paquete `deeptime` y a침ade intervalos geol칩gicos autom치ticamente
axis_geo(side = 1, intervals = list("epochs", "periods"))

# Agregar la etiqueta del eje X, desplazada hacia abajo
title(xlab = "Time (Ma)", line = 4)

```

# Macrostrat

Todos los datos usados por Macrostrat se encuentran en su base de datos <https://macrostrat.org/> .

Vamos trabajar con datos geol칩gicos reales utilizando el paquete `rmacrostrat` en R. Nuestro objetivo es encontrar y mapear los afloramientos de la famosa **Formaci칩n Hell Creek**, una unidad geol칩gica crucial para entender el l칤mite Cret치cico-Pale칩geno (K/Pg) en Norteam칠rica. Este ejercicio est치 inspirado por un ejemplo de [Palaeoverse](https://palaeoverse.r-universe.dev/articles/rmacrostrat/geologic-map.html)

## Contexto Geol칩gico: La Formaci칩n Hell Creek

La **Formaci칩n Hell Creek** es una unidad geol칩gica que aflora en Montana, Dakota del Norte y Dakota del Sur (Estados Unidos). Data del Cret치cico Superior (Maastrichtiano) al Pale칩geno temprano, y es famosa por su excepcional registro f칩sil, que incluye dinosaurios ic칩nicos como *Edmontosaurus*, *Triceratops* y *Tyrannosaurus rex*, y mam칤feros, justo antes de la extinci칩n masiva del K/Pg hace aproximadamente 66 millones de a침os. Est치 compuesta por arcillolitas, lutitas y arenitas depositadas por un sistema fluvial en la costa del Mar Interior Occidental.

## Extrayendo los Datos (Fetching)

Lo primero que necesitamos son los identificadores de nombres estratigr치ficos (`strat_name_ids`) asociados con la Formaci칩n Hell Creek. Estos IDs est치n vinculados a nombres estratigr치ficos 칰nicos en la base de datos **Macrostrat**. Podemos buscar los IDs relevantes usando las funciones `def_*` que proporcionan informaci칩n sobre los datos en la base de datos.

```{r}
# Buscar nombres estratigr치ficos para "Hell Creek"
def_strat_names(strat_name = "hell creek")
```

Hay un total de 3 nombres correspondientes, los tres comparten el mismo `concept_id` (`8598`). Esto indica que estos nombres estratigr치ficos est치n unidos bajo una misma entidad geol칩gica. Por lo tanto, podemos usar este `concept_id` para buscar todas las referencias a "Hell Creek":

Ahora, vamos a usar los `strat_name_ids` asociados con el `concept_id` de Hell Creek para obtener los datos espaciales. Para esto, usaremos la funci칩n `get_map_outcrop()`, que nos permite obtener pol칤gonos de afloramiento de mapas geol칩gicos. Especificaremos que queremos la salida como un objeto `sf` (simple features). Un objeto `sf` es una colecci칩n de "caracter칤sticas simples" (representaciones de objetos del mundo real) que incluye atributos y geometr칤as en un `data.frame`.

```{r}
# Buscar nombres estratigr치ficos asociados con el concept_id de Hell Creek
hc_def <- def_strat_names(concept_id = 8598)

# Obtener informaci칩n espacial de afloramientos asociada con cada strat_name_id de Hell Creek
hc <- get_map_outcrop(strat_name_id = hc_def$strat_name_id, sf = TRUE)

head(hc, n =1)
```

## Visualizar 

Vamos a crear un mapa de forma sencilla

```{r}

# Plot the map
ggplot() +
  geom_sf(data = hc, fill = "#C7622B", lwd = 0) +
  coord_sf(xlim = c(-112, -97), ylim = c(44, 50)) +
  annotation_north_arrow(location = "br",
                         pad_y = unit(0.75, "cm"),
                         height = unit(1, "cm"), width = unit(1, "cm")) +
  annotation_scale(location = "br", width_hint = 0.3) +
  theme_bw()
```

::: callout-important
## Ejercicio

Busca infromaci칩n de la Formaci칩n que quieras y crea un mapa con su extensi칩n
:::

# Phylopic

El paquete **`rphylopic`** en R facilita la b칰squeda y visualizaci칩n de siluetas de organismos de la base de datos **PhyloPic**, permiti칠ndote incorporarlas f치cilmente a tus gr치ficos. Puedes a침adir estas siluetas como capas o puntos de datos tanto en gr치ficos de R base como en gr치ficos de `ggplot2`. Adem치s, `rphylopic` ofrece funciones para elegir entre siluetas disponibles, transformarlas (rotar, cambiar color) y guardar las im치genes.

## Funcionamiento

Cada silueta en `phylopic` tiene un **Identificador 칔nico Universal (UUID)**. El primer paso para usar una silueta es obtener su UUID.

La funci칩n clave es `get_uuid()`, que permite buscar siluetas en `PhyloPic` usando nombres taxon칩micos o filogen칠ticos (por ejemplo, "Canis lupus" o "pan-Mollusca"). Por defecto, `get_uuid()` devuelve el UUID de la primera coincidencia. Una vez que tienes el UUID, puedes usar `get_phylopic()` para obtener la silueta.

Sin embargo, a menudo existen **m칰ltiples siluetas** para un mismo nombre. Puedes usar el argumento `n` en `get_uuid()` para obtener varios UUIDs coincidentes.

```{r}
# Obtener un 칰nico UUID para una especie (ej. lobo)
uuid_lobo <- get_uuid(name = "Canis lupus")

# Obtener la imagen para ese UUID
img_lobo <- get_phylopic(uuid = uuid_lobo)

# Pero si existen m칰ltiples siluetas, podemos obtener varios UUIDs:
multi_uuids_lobo <- get_uuid(name = "Canis lupus", n = 5)
print(multi_uuids_lobo) 
```

## Elegir una imagen

Si hay m칰ltiples siluetas, puede ser dif칤cil elegir la correcta sin verlas. La funci칩n`pick_phylopic()` es muy 칰til porque muestra las siluetas y permite seleccionar la que deseas de forma interactiva.

```{r}
# Mostrar las primeras 4 siluetas de Canis lupus e interactuar para elegir
# Una ventana se abrir치 para que selecciones la imagen deseada.
# Por ejemplo, si eliges la opci칩n 1:
# img_seleccionada <- pick_phylopic(name = "Canis lupus", n = 4, view = 4)
```

```{r}
#| message: false
#| warning: false

# Crear un gr치fico ggplot2 base
p <- ggplot() +
  coord_cartesian(xlim = c(0.6, 1.4), ylim = c(0.6, 1.4)) +
  labs(x = "Coordenada X", y = "Coordenada Y", title = "Siluetas en ggplot2")

# A침adir la imagen seleccionada (la que guardamos en img_seleccionada)
p <- p + add_phylopic(img = img_lobo, x = 1.25, y = 1.25, height = 0.25)

# A침adir otra silueta directamente usando el UUID
uuid_ggplot <- get_uuid(name = "Canis lupus", n = 1)
p <- p + add_phylopic(uuid = uuid_ggplot, x = 1, y = 1, height = 0.25)

# A침adir la primera silueta vinculada a un nombre directamente
p + add_phylopic(name = "Canis lupus", x = 0.75, y = 0.75, height = 0.25)
```

::: callout-important
## Ejercicio

Busca y elige siluetas para el taxon que quieras
:::

::: callout-important
## Ejercicio

Crea una gr치fica de dispersi칩n usando los datos de Palmer Penguins, donde cada puntos sea una silueta de ping칲ino.

-   Deben usar `geom_phylopic(img = pinguino)`
:::

```{r}
#| warning: false
#| code-fold: true

uuid <- get_uuid(name = "Pygoscelis", n =3)
# Get the image for that UUID
pinguino <- get_phylopic(uuid = uuid[3])

```

```{r}
#| warning: false
#| code-fold: true
library(palmerpenguins)
# Elegimos la silueta que deseamos
ggplot(penguins) +
  # Gr치fica de dispersi칩n
  geom_phylopic(img = pinguino,
             aes(x = bill_depth_mm, y = bill_length_mm, color = species),
             height = 1.5,show.legend = TRUE, 
             key_glyph = phylopic_key_glyph(img = pinguino)) +
  # Seleccionamos la escala de colores para que cuadre
  scale_colour_manual(values = c("darkorange","purple","cyan4")) +
  #Le damos un t칤tulo 
  ggtitle(substitute(paste("Medidas del pico por especie del g칠nero ", italic("Pygoscelis"))))+
  # Cambiamos los nombres de los ejes
  xlab("Profundidad del pico (mm)")+
  ylab("Largo del pico (mm)") +
  labs("Especies")+
  # Ajustamos el t칤tulo y cambiamos la leyenda cursiva
  theme(plot.title = element_text(vjust = 0, hjust = 0.5),legend.text = element_text(face = "italic"))
```

```{r}
citation("palaeoverse")
citation("rmacrostrat")
citation("rphylopic")
```
